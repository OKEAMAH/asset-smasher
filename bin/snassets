#!/usr/bin/env node

var program = require('commander');
var fs = require('fs');
var path = require('path');
var Snassets = require('../lib/index.js').Snassets;

function listify(val) {
  return val.split(',');
}

program.
  version(require('../package.json').version).
  usage('[options] <output dir> [file ...]').
  option('--compress', 'compress/minify the generated files').
  option('--hash', 'generate versions of the files with md5 hashes in the name').
  option('--gzip', 'generate gzipped versions of the compiled files').
  option('--hashVersion <version>', 'invalidate all assets without changing file contents [1.0]', '1.0').
  option('--only <pattern,...>', 'only process the files matching patterns (relative to any of the paths) [**/*]', listify).
  option('--paths <path,...>', 'list of paths to look for assets [.]', listify, [process.cwd()]).
  option('--prefix <prefix>', 'prefix to append to referenced paths []', '').
  option('--helpers <js_file>', 'a .js file of helper functions require()s to expose to transforms []');

program.on('--help', function() {
  console.log('  If --only is not specified, *all* files in the --paths will be processed.');
  console.log('  Files passed to --only can be glob patterns.');
  console.log('');
  console.log('  Examples:');
  console.log('');
  console.log('    $ snassets output');
  console.log('    $ snassets --compress --hash --prefix=/assets \\\n        --paths=./js,./css --only **/*.{jpg,gif,png},application.js.mf output');
  console.log('    $ snassets --helpers helpers.js output');
});

program.parse(process.argv);

var outputTo = program.args.shift();
if (!outputTo) {
  console.error();
  console.error('  error: missing output directory');
  console.error();
  process.exit(1);
}
try {
  var stat = fs.statSync(outputTo);
  if(!stat.isDirectory()) {
    console.error();
    console.error('  error: output directory is not a directory');
    console.error();
    process.exit(1);
  }
} catch(e) {
  // Ignore, we'll create the directory
}

var snass = new Snassets({
  paths:program.paths,
  only:program.only,
  prefix:program.prefix,
  compress:program.compress,
  hash:program.hash,
  gzip:program.gzip,
  version:program.hashVersion,
  outputTo:outputTo,
  helpers:program.helpers ? require(path.resolve(program.helpers)) : null
});
var startTime = Date.now();
snass.compileAssets(function(err) {
  if(err) {
    console.error();
    console.error('  error: %s', err.message);
    console.error(err);
    console.error();
    process.exit(1);
  } else {
    console.log('Finished in %d ms', (Date.now() - startTime));
  }
});
